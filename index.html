<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carte Projets — Stockage partagé Google Sheets</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<style>
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #layout{display:grid;grid-template-columns:420px 1fr;height:100%}
  #side{padding:14px;overflow:auto;border-right:1px solid #ddd}
  #map{width:100%;height:100%}
  .card{border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:10px}
  .row{display:flex;gap:8px}.row>*{flex:1}
  .btn{padding:8px 10px;border:1px solid #bbb;border-radius:8px;background:#f5f5f5;cursor:pointer}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left}
  .legend{position:absolute;bottom:20px;left:20px;z-index:1000;background:#fff;border:1px solid #333;border-radius:8px;padding:8px 10px}
  .legend .item{display:flex;align-items:center;gap:6px;margin-bottom:4px}
  .legend .sw{width:12px;height:12px;border:1px solid #333}
</style>
</head>
<body>
<div id="layout">
  <div id="side">
    <h3>Gestion & Suivi de Projets (Sheets)</h3>

    <div class="card">
      <div class="row">
        <button class="btn" id="load-sheets">Charger (Sheets)</button>
        <button class="btn" id="save-sheets">Publier (Sheets)</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="export">Exporter GeoJSON</button>
        <button class="btn" id="import">Importer GeoJSON</button>
      </div>
      <input type="file" id="file" style="display:none" accept=".geojson,.json" />
      <div style="margin-top:6px;font-size:12px;opacity:.8">
        Remplacez la constante <code>SHEETS_URL</code> par l’URL de votre Apps Script (déployé en web app).
      </div>
    </div>

    <div class="card">
      <div class="row"><div><label>Nom</label><input id="nom" style="width:100%"></div></div>
      <div class="row">
        <div><label>Montant</label><input id="montant" style="width:100%"></div>
        <div><label>Décaissé</label><input id="montant_decaisse" style="width:100%"></div>
      </div>
      <div class="row">
        <div><label>Région</label><input id="region" style="width:100%"></div>
        <div><label>Statut</label>
          <select id="statut" style="width:100%">
            <option>Planifié</option><option>En cours</option><option>En retard</option><option>Terminé</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label>Responsable</label><input id="responsable" style="width:100%"></div>
        <div><label>Taux exéc. (%)</label><input id="taux_execution" style="width:100%"></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="apply">Associer au dessin sélectionné</button>
        <button class="btn" id="clear">Effacer</button>
      </div>
    </div>

    <div class="card">
      <b>Synthèse</b>
      <div style="margin-top:6px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>Total: <b id="sum-total">0</b></div>
        <div>Décaissé: <b id="sum-decaisse">0</b></div>
        <div>Taux décaissement: <b id="sum-taux-dec">0%</b></div>
        <div>Taux exécution (pondéré): <b id="sum-taux-exec">0%</b></div>
      </div>
    </div>

    <div class="card">
      <b>Liste (affichée)</b>
      <table>
        <thead><tr><th>Projet</th><th>Région</th><th>Statut</th><th>Montant</th><th>Décaissé</th><th>% Déc.</th><th>% Exéc.</th><th>Resp.</th></tr></thead>
        <tbody id="tbl"></tbody>
      </table>
    </div>
  </div>

  <div id="map">
    <div id="legend" class="legend" style="display:none">
      <div id="legendItems"></div>
    </div>
  </div>
</div>

<script>
// === CONFIG: remplacez par l'URL de votre Apps Script déployé (doGet/doPost) ===
const SHEETS_URL = "https://script.google.com/macros/s/REPLACE_WITH_YOURS/exec";

const map = L.map('map').setView([14.7,-17.4], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OSM'}).addTo(map);
const allItems = new L.FeatureGroup().addTo(map);
map.addControl(new L.Control.Draw({draw:{polygon:true,polyline:true,rectangle:true,circle:false,marker:true,circlemarker:false},edit:{featureGroup:allItems}}));

let sel=null;
const STATUS_COLORS={"Planifié":"#1f77b4","En cours":"#2ca02c","En retard":"#d62728","Terminé":"#9467bd"};
const FALLBACK=["#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];const extra={};
function colorForStatut(s){if(STATUS_COLORS[s])return STATUS_COLORS[s]; if(!extra[s]) extra[s]=FALLBACK[(Object.keys(extra).length)%FALLBACK.length]; return extra[s];}
function toFeature(layer){const gj=layer.toGeoJSON(); gj.properties=gj.properties||{}; return gj;}
function money(n){try{return new Intl.NumberFormat('fr-FR',{maximumFractionDigits:0}).format(n);}catch(e){return String(n);}}
function pct(x){return isFinite(x)?(Math.round(x*1000)/10)+'%':'0%';}
function toNum(v){if(v==null||v==='')return 0;const t=(''+v).replace(/\s/g,'').replace(',','.');const n=Number(t);return isFinite(n)?n:0;}
function popupHtml(p){const mt=toNum(p.montant),md=toNum(p.montant_decaisse),td=mt>0?md/mt:0;
  return `<b>${p.nom||'Projet'}</b><br><i>Région:</i> ${p.region||''}<br><i>Statut:</i> ${p.statut||''}<br>
  <i>Montant:</i> ${p.montant||''}<br><i>Décaissé:</i> ${p.montant_decaisse||''} (${pct(td)})<br>
  <i>Resp.:</i> ${p.responsable||''}<br><i>Taux exéc.:</i> ${p.taux_execution? p.taux_execution+'%' : ''}`;}
function bindUI(l,p){l.bindTooltip(p.nom||'Projet'); l.bindPopup(popupHtml(p),{maxWidth:420});}
function applyStyle(l,props){
  const color=colorForStatut(props.statut||'');
  if(l instanceof L.Marker && !l._isCircle){
    const cm=L.circleMarker(l.getLatLng(),{radius:7,weight:1,color:"#000",fillColor:color,fillOpacity:0.9});
    cm._isCircle=true; if(l._popup) cm.bindPopup(l._popup.getContent()); if(l._tooltip) cm.bindTooltip(l._tooltip._content);
    allItems.removeLayer(l); allItems.addLayer(cm); return cm;
  }
  if(l.setStyle) l.setStyle({color,weight:2,fillOpacity:0.35});
  return l;
}
function setProps(l,props){const f=toFeature(l); f.properties=Object.assign({},f.properties||{},props); l.feature=f; bindUI(l,f.properties); return applyStyle(l,f.properties);}

function refreshTableAndLegend(){
  const tb=document.getElementById('tbl'); tb.innerHTML='';
  let total=0,dec=0,wx=0; const statuses=new Set();
  allItems.eachLayer(l=>{
    if(!map.hasLayer(l)) return;
    const p=(l.feature&&l.feature.properties)||{};
    const m=toNum(p.montant), d=toNum(p.montant_decaisse), t=m>0?d/m:0, te=toNum(p.taux_execution);
    total+=m; dec+=d; wx+=(isFinite(te)?te:0)*m; if(p.statut) statuses.add(p.statut);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.nom||''}</td><td>${p.region||''}</td><td>${p.statut||''}</td>
                  <td>${p.montant||''}</td><td>${p.montant_decaisse||''}</td><td>${pct(t)}</td>
                  <td>${p.taux_execution? p.taux_execution+'%' : ''}</td><td>${p.responsable||''}</td>`;
    tb.appendChild(tr);
  });
  const td=total>0?dec/total:0, te=total>0?wx/total:0;
  document.getElementById('sum-total').textContent=money(total);
  document.getElementById('sum-decaisse').textContent=money(dec);
  document.getElementById('sum-taux-dec').textContent=pct(td);
  document.getElementById('sum-taux-exec').textContent=(Math.round(te*10)/10)+'%';
  buildLegend(Array.from(statuses).filter(Boolean).sort());
}
function buildLegend(values){
  const cont=document.getElementById('legend'), items=document.getElementById('legendItems');
  items.innerHTML=''; if(!values.length){cont.style.display='none';return;}
  values.forEach(v=>{const c=colorForStatut(v); const div=document.createElement('div'); div.className='item'; div.innerHTML=`<span class="sw" style="background:${c}"></span><span>${v}</span>`; items.appendChild(div);});
  cont.style.display='block';
}

// Formulaire
document.getElementById('apply').onclick=()=>{
  if(!sel){alert('Sélectionnez un objet.'); return;}
  let l=sel;
  const p={nom:nom.value.trim(),montant:montant.value.trim(),montant_decaisse:montant_decaisse.value.trim(),region:region.value.trim(),statut:statut.value,responsable:responsable.value.trim(),taux_execution:(()=>{const v=parseFloat(taux_execution.value.replace(',','.'));return isFinite(v)?String(v):'';})()};
  l=setProps(l,p); sel=l; refreshTableAndLegend();
};
document.getElementById('clear').onclick=()=>{['nom','montant','montant_decaisse','region','responsable','taux_execution'].forEach(id=>document.getElementById(id).value=''); statut.value='Planifié';};

// Sélection
allItems.on('click',e=>{
  sel=e.layer; const p=(sel.feature&&sel.feature.properties)||{};
  nom.value=p.nom||''; montant.value=p.montant||''; montant_decaisse.value=p.montant_decaisse||'';
  region.value=p.region||''; statut.value=p.statut||'Planifié'; responsable.value=p.responsable||''; taux_execution.value=p.taux_execution||'';
});

// Import / Export
document.getElementById('export').onclick=()=>{
  const feats=[]; allItems.eachLayer(l=>feats.push(toFeature(l)));
  const blob=new Blob([JSON.stringify({type:'FeatureCollection',features:feats},null,2)],{type:'application/geo+json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='projets.geojson'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),300);
};
document.getElementById('import').onclick=()=>file.click();
document.getElementById('file').onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{ const t=await f.text(); const j=JSON.parse(t); renderGeoJSON(j); }catch(err){ alert('Import KO: '+err.message); }
};

// Rendu GeoJSON
function renderGeoJSON(j){
  allItems.clearLayers();
  const g = L.geoJSON(j,{
    style: f => ({ color: colorForStatut((f.properties||{}).statut||''), weight:2, fillOpacity:0.35 }),
    pointToLayer: (f, latlng) => {
      const c = colorForStatut((f.properties||{}).statut||'');
      const cm = L.circleMarker(latlng,{radius:7,weight:1,color:"#000",fillColor:c,fillOpacity:0.9});
      cm._isCircle = true; return cm;
    },
    onEachFeature: (feat, lay) => { allItems.addLayer(lay); lay.feature = feat; bindUI(lay, feat.properties || {}); }
  });
  try{ const b=g.getBounds(); if(b && b.isValid()) map.fitBounds(b.pad(0.2)); }catch(e){}
  refreshTableAndLegend();
}

// Dessin
map.on(L.Draw.Event.CREATED,e=>{let l=e.layer; allItems.addLayer(l); sel=l; l=setProps(l,{}); refreshTableAndLegend();});
map.on(L.Draw.Event.EDITED,()=>{refreshTableAndLegend();});
map.on(L.Draw.Event.DELETED,()=>{sel=null; refreshTableAndLegend();});

// ======= Google Sheets: charger / publier =======
async function loadFromSheets(){
  try{
    const r = await fetch(SHEETS_URL, { cache:'no-store' });
    if(!r.ok){ alert("Impossible de charger depuis Sheets (vérifiez l'URL Apps Script)."); return; }
    const j = await r.json();
    renderGeoJSON(j);
    alert("Données chargées depuis Google Sheets ✅");
  }catch(e){ alert("Erreur Sheets (GET): "+e.message); }
}
async function saveToSheets(){
  try{
    const feats=[]; allItems.eachLayer(l=>feats.push(toFeature(l)));
    const body = { type:'FeatureCollection', features:feats };
    const r = await fetch(SHEETS_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(!r.ok){ const t=await r.text(); throw new Error(t||"POST non OK"); }
    alert("Données publiées vers Google Sheets ✅");
  }catch(e){ alert("Erreur Sheets (POST): "+e.message); }
}
document.getElementById('load-sheets').onclick=loadFromSheets;
document.getElementById('save-sheets').onclick=saveToSheets;

// Exemple si la feuille est vide
setTimeout(()=>{
  if(allItems.getLayers().length===0){
    let seed=L.circleMarker([14.67,-17.07],{radius:7,weight:1,color:"#000",fillColor:"#2ca02c",fillOpacity:0.9}).addTo(allItems);
    setProps(seed,{nom:'Exemple — Forage de Ndiass',montant:'125000000',montant_decaisse:'80000000',region:'Thiès',statut:'En cours',responsable:'A. Diop',taux_execution:'65'});
    refreshTableAndLegend();
  }
},500);
</script>
</body>
</html>
