<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carte Projets ‚Äî points/ic√¥nes + filtres + synth√®ses + GitHub</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<style>
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #layout{display:grid;grid-template-columns:500px 1fr;height:100vh}
  #side{padding:14px;overflow:auto;border-right:1px solid #ddd;background:#fafafa}
  #map{width:100%;height:100%}
  h3{margin:0 0 10px}
  .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:12px;background:#fff}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>*{flex:1 1 45%}
  label{font-size:12px;opacity:.85}
  input,select{padding:8px;border:1px solid #ccc;border-radius:8px}
  .btn{padding:8px 10px;border:1px solid #bbb;border-radius:8px;background:#f5f5f5;cursor:pointer}
  .btn.warn{background:#ffe9e9;border-color:#f3b0b0}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left;vertical-align:top}
  th{position:sticky;top:0;background:#fff;z-index:1}
  .legend{position:absolute;bottom:20px;left:20px;z-index:1000;background:#fff;border:1px solid #333;border-radius:8px;padding:8px 10px}
  .legend .item{display:flex;align-items:center;gap:6px;margin-bottom:4px}
  .legend .sw{width:12px;height:12px;border:1px solid #333}
  .small{font-size:12px;opacity:.85}
</style>
</head>

<body>
<div id="layout">
  <div id="side">
    <h3>Gestion & Suivi de Projets</h3>

    <!-- FILTRES -->
    <div class="card">
      <b>Filtres</b>
      <div class="row" style="margin-top:6px">
        <div>
          <label>Statut</label>
          <select id="filtre-statut" style="width:100%"><option value="">Tous</option></select>
        </div>
        <div>
          <label>R√©gion</label>
          <select id="filtre-region" style="width:100%"><option value="">Toutes</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btn-reset">R√©initialiser</button>
      </div>
    </div>

    <!-- SAISIE / EDITION -->
    <div class="card">
      <b>Saisie / √âdition</b>

      <div class="row" style="margin-top:6px">
        <div style="flex:1 1 100%">
          <label>Nom</label>
          <input id="nom" style="width:100%" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Montant</label>
          <input id="montant" style="width:100%" />
        </div>
        <div>
          <label>Montant d√©caiss√©</label>
          <input id="montant_decaisse" style="width:100%" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>R√©gion</label>
          <input id="region" style="width:100%" />
        </div>
        <div>
          <label>Statut</label>
          <select id="statut" style="width:100%">
            <option>Planifi√©</option>
            <option>En cours</option>
            <option>En retard</option>
            <option>Termin√©</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Responsable</label>
          <input id="responsable" style="width:100%" />
        </div>
        <div>
          <label>Taux d'ex√©cution (%)</label>
          <input id="taux_execution" style="width:100%" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1 1 100%">
          <label>Ic√¥ne (optionnel)</label>
          <select id="icone" style="width:100%">
            <option value="">‚óè Point normal</option>
            <option value="üìç">üìç Projet</option>
            <option value="üè•">üè• Sant√©</option>
            <option value="üè´">üè´ √âducation</option>
            <option value="‚ö°">‚ö° √ânergie</option>
            <option value="üõ£Ô∏è">üõ£Ô∏è Route</option>
            <option value="üèóÔ∏è">üèóÔ∏è B√¢timent</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="apply">Associer au dessin s√©lectionn√©</button>
        <button class="btn" id="clear">Effacer</button>
        <button class="btn warn" id="del-selected">Supprimer ce projet</button>
      </div>

      <div class="small" style="margin-top:6px">
        Astuce : pose un point (outil √† gauche), puis saisis et clique <b>Associer</b>.
      </div>
    </div>

    <!-- SYNTHESE GLOBALE -->
    <div class="card">
      <b>Synth√®se (filtr√©e)</b>
      <div style="margin-top:6px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>Total: <b id="sum-total">0</b></div>
        <div>D√©caiss√©: <b id="sum-decaisse">0</b></div>
        <div>Taux d√©caissement: <b id="sum-taux-dec">0%</b></div>
        <div>Taux ex√©cution (pond√©r√©): <b id="sum-taux-exec">0%</b></div>
      </div>
    </div>

    <!-- LISTE -->
    <div class="card">
      <b>Liste (filtr√©e)</b>
      <div style="overflow:auto;max-height:280px">
        <table>
          <thead>
            <tr>
              <th></th><th></th>
              <th>Projet</th><th>R√©gion</th><th>Statut</th>
              <th>Montant</th><th>D√©caiss√©</th><th>% D√©c.</th><th>% Ex√©c.</th><th>Resp.</th>
            </tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>

    <!-- SYNTHESE PAR STATUT -->
    <div class="card">
      <b>Synth√®se par Statut (filtr√©e)</b>
      <table id="tblStatut">
        <thead>
          <tr><th>Statut</th><th>Nb</th><th>Montant</th><th>D√©caiss√©</th><th>% D√©c.</th><th>% Ex√©c. pond√©r√©</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SYNTHESE PAR REGION -->
    <div class="card">
      <b>Synth√®se par R√©gion (filtr√©e)</b>
      <table id="tblRegion">
        <thead>
          <tr><th>R√©gion</th><th>Nb</th><th>Montant</th><th>D√©caiss√©</th><th>% D√©c.</th><th>% Ex√©c. pond√©r√©</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- IMPORT / EXPORT / GITHUB -->
    <div class="card">
      <div class="row">
        <button class="btn" id="export">Exporter GeoJSON</button>
        <button class="btn" id="import">Importer GeoJSON</button>
      </div>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="gh-load">Charger (GitHub)</button>
        <button class="btn" id="gh-save">Publier (GitHub)</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="gh-token">Enregistrer Token</button>
        <button class="btn warn" id="gh-token-clear">Effacer Token</button>
      </div>

      <div class="small" style="margin-top:6px">
        Fichier : <b>data/projets.geojson</b> (GitHub)
      </div>

      <input type="file" id="file" style="display:none" accept=".geojson,.json" />
    </div>
  </div>

  <div id="map">
    <div id="legend" class="legend" style="display:none">
      <div id="legendItems"></div>
    </div>
  </div>
</div>

<script>
// ================== DONN√âES INT√âGR√âES (exemple) ==================
const INITIAL_DATA = {"type":"FeatureCollection","features":[
  {"type":"Feature","properties":{"nom":"Exemple ‚Äî Forage de Ndiass","montant":"125000000","montant_decaisse":"80000000","region":"Thi√®s","statut":"En cours","responsable":"A. Diop","taux_execution":"65"},"geometry":{"type":"Point","coordinates":[-17.07,14.67]}},
  {"type":"Feature","properties":{"nom":"Construction terminal port de dakar","montant":"45000000000","montant_decaisse":"","region":"Dakar","statut":"Planifi√©","responsable":"DIP","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-17.442169,14.681911]}},
  {"type":"Feature","properties":{"nom":"Construction Hh√¥pital de Saint louis","montant":"46000000000","montant_decaisse":"12000000000","region":"Saint louis","statut":"En retard","responsable":"DIS","taux_execution":"15"},"geometry":{"type":"Point","coordinates":[-16.413574,16.193575]}},
  {"type":"Feature","properties":{"nom":"Construction Hopital regional de K√©dougou","montant":"25000000000","montant_decaisse":"25000000000","region":"K√©dougou","statut":"Termin√©","responsable":"DIS","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-12.403564,12.715368]}},
  {"type":"Feature","properties":{"nom":"Construction pont de Ziguinchor","montant":"52000000000","montant_decaisse":"","region":"Ziguinchor","statut":"Planifi√©","responsable":"Ageroute","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-16.261139,12.537137]}},
  {"type":"Feature","properties":{"nom":"Construction lyc√©e de Matam","montant":"2500000000","montant_decaisse":"1200000000","region":"Matam","statut":"En cours","responsable":"DIE","taux_execution":"45"},"geometry":{"type":"Point","coordinates":[-13.820801,15.871525]}},
  {"type":"Feature","properties":{"nom":"Construction du port sec de Tambacounda","montant":"54000000000","montant_decaisse":"","region":"Tambacounda","statut":"Planifi√©","responsable":"AGEROUTE","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-13.612061,13.624633]}},
  {"type":"Feature","properties":{"nom":"Construction h√¥pital de Touba","montant":"46000000000","montant_decaisse":"25000000000","region":"Diourbel","statut":"En cours","responsable":"","taux_execution":"60"},"geometry":{"type":"Point","coordinates":[-15.954895,14.839939]}},
  {"type":"Feature","properties":{"nom":"Construction centre de sant√© de Lingu√®re","montant":"3000000000","montant_decaisse":"3000000000","region":"Louga","statut":"Termin√©","responsable":"","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-15.249023,15.315976]}}
]};

// ================== OUTILS ==================
const STATUS_COLORS = {"Planifi√©":"#1f77b4","En cours":"#2ca02c","En retard":"#d62728","Termin√©":"#9467bd"};
const FALLBACK=["#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
const extra={};
function colorForStatut(s){ if(STATUS_COLORS[s]) return STATUS_COLORS[s]; if(!extra[s]) extra[s]=FALLBACK[(Object.keys(extra).length)%FALLBACK.length]; return extra[s]; }
function toNum(v){ if(v==null||v==='') return 0; const t=(''+v).replace(/\s/g,'').replace(',','.'); const n=Number(t); return isFinite(n)?n:0; }
function money(n){ try{return new Intl.NumberFormat('fr-FR',{maximumFractionDigits:0}).format(n);}catch(e){return String(n);} }
function pct(x){ return isFinite(x)?(Math.round(x*1000)/10)+'%':'0%'; }

function toFeature(layer){
  const gj=layer.toGeoJSON();
  gj.properties = gj.properties || {};
  return gj;
}

// ================== CARTE ==================
const map = L.map('map').setView([14.7,-17.4], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'}).addTo(map);

const allItems = new L.FeatureGroup().addTo(map);
map.addControl(new L.Control.Draw({
  draw:{polygon:true,polyline:true,rectangle:true,circle:false,marker:true,circlemarker:false},
  edit:{featureGroup:allItems}
}));

let sel = null;

// ================== POPUP / TOOLTIP ==================
function popupHtml(p){
  const mt = toNum(p.montant), md=toNum(p.montant_decaisse);
  const td = mt>0 ? md/mt : 0;
  return `<b>${p.nom||'Projet'}</b><br>
    <i>R√©gion:</i> ${p.region||''}<br>
    <i>Statut:</i> ${p.statut||''}<br>
    <i>Montant:</i> ${p.montant||''}<br>
    <i>D√©caiss√©:</i> ${p.montant_decaisse||''} (${pct(td)})<br>
    <i>Resp.:</i> ${p.responsable||''}<br>
    <i>Taux ex√©c.:</i> ${p.taux_execution? p.taux_execution+'%' : ''}` + (p.icone?`<br><i>Ic√¥ne:</i> ${p.icone}`:'');
}
function bindUI(layer, props){
  layer.bindTooltip(props.nom||'Projet');
  layer.bindPopup(popupHtml(props),{maxWidth:420});
}

// ================== STYLE ==================
function applyStyle(l, props){
  const c = colorForStatut(props.statut||'');
  if (l instanceof L.CircleMarker){
    l.setStyle({radius:7, weight:1, color:"#000", fillColor:c, fillOpacity:0.9});
  } else if (l.setStyle){
    l.setStyle({color:c, weight:2, fillOpacity:0.35});
  }
  return l;
}

// ic√¥ne emoji (optionnel) : si ic√¥ne renseign√©e et g√©om√©trie = point => marker emoji
function applyEmojiIcon(layer, props){
  const emoji = (props && props.icone) ? props.icone : '';
  if (!emoji) return layer;

  const latlng = layer.getLatLng ? layer.getLatLng() : null;
  if (!latlng) return layer;

  const icon = L.divIcon({
    className: '',
    html: `<div style="font-size:22px;line-height:22px">${emoji}</div>`,
    iconSize: [22, 22],
    iconAnchor: [11, 11]
  });

  // si d√©j√† marker: setIcon
  if (layer instanceof L.Marker){
    layer.setIcon(icon);
    return layer;
  }

  // sinon (circleMarker), remplace par Marker
  const m = L.marker(latlng, { icon });
  m.feature = layer.feature;
  if (layer._popup)   m.bindPopup(layer._popup.getContent());
  if (layer._tooltip) m.bindTooltip(layer._tooltip._content);

  allItems.removeLayer(layer);
  allItems.addLayer(m);
  return m;
}

function setProps(layer, props){
  const f = toFeature(layer);
  f.properties = Object.assign({}, f.properties||{}, props);
  layer.feature = f;

  bindUI(layer, f.properties);

  // si c‚Äôest un Marker ‚Äústandard‚Äù, on le convertit en circleMarker par d√©faut (point normal)
  // MAIS si ic√¥ne est d√©finie => applyEmojiIcon mettra un Marker emoji
  if (layer instanceof L.Marker && !(layer instanceof L.CircleMarker)){
    // si ce marker vient du draw, on le remplace par un circleMarker pour garder le style point
    const cm = L.circleMarker(layer.getLatLng(), {radius:7, weight:1, color:"#000", fillColor:colorForStatut(f.properties.statut||''), fillOpacity:0.9});
    cm.feature = layer.feature;
    if (layer._popup)   cm.bindPopup(layer._popup.getContent());
    if (layer._tooltip) cm.bindTooltip(layer._tooltip._content);
    allItems.removeLayer(layer);
    allItems.addLayer(cm);
    layer = cm;
  }

  const styled = applyStyle(layer, f.properties);
  const finalLayer = applyEmojiIcon(styled, f.properties);
  sel = finalLayer;
  return finalLayer;
}

// ================== FORMULAIRE (clic sur point) ==================
const nom = document.getElementById('nom');
const montant = document.getElementById('montant');
const montant_decaisse = document.getElementById('montant_decaisse');
const region = document.getElementById('region');
const statut = document.getElementById('statut');
const responsable = document.getElementById('responsable');
const taux_execution = document.getElementById('taux_execution');
const icone = document.getElementById('icone');

function remplirDepuisLayer(layer){
  sel = layer;
  const p = (layer.feature && layer.feature.properties) || {};
  nom.value = p.nom || '';
  montant.value = p.montant || '';
  montant_decaisse.value = p.montant_decaisse || '';
  region.value = p.region || '';
  statut.value = p.statut || 'Planifi√©';
  responsable.value = p.responsable || '';
  taux_execution.value = p.taux_execution || '';
  icone.value = p.icone || '';
}

// clic sur un objet => remplir comme avant
allItems.on('click', (e)=> remplirDepuisLayer(e.layer));

// ================== FILTRES ==================
const fStatut = document.getElementById('filtre-statut');
const fRegion = document.getElementById('filtre-region');

function uniqueSorted(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>(''+a).localeCompare(b,'fr')); }

function buildFilterOptions(){
  const stats=[], regs=[];
  allItems.eachLayer(l=>{
    const p=(l.feature && l.feature.properties) || {};
    stats.push(p.statut);
    regs.push(p.region);
  });
  const s=uniqueSorted(stats), r=uniqueSorted(regs);
  fStatut.innerHTML = '<option value="">Tous</option>' + s.map(x=>`<option>${x}</option>`).join('');
  fRegion.innerHTML = '<option value="">Toutes</option>' + r.map(x=>`<option>${x}</option>`).join('');
}

function matchFilter(p){
  const s=fStatut.value, r=fRegion.value;
  if (s && (p.statut||'')!==s) return false;
  if (r && (p.region||'')!==r) return false;
  return true;
}

document.getElementById('btn-reset').onclick=()=>{ fStatut.value=""; fRegion.value=""; applyFilters(); };
fStatut.onchange = fRegion.onchange = ()=>applyFilters();

// ================== TABLE + SYNTHESES ==================
function fillGroupedTable(rows, key, tableId){
  const tbody = document.querySelector('#'+tableId+' tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  const by = {};
  rows.forEach(r=>{
    const k = r[key] || '(vide)';
    if(!by[k]) by[k] = { nb:0, m:0, d:0, wx:0 };
    by[k].nb += 1;
    by[k].m  += r.montant;
    by[k].d  += r.decaisse;
    by[k].wx += r.tauxExec * r.montant;
  });

  Object.keys(by).sort((a,b)=>(''+a).localeCompare(b,'fr')).forEach(k=>{
    const o = by[k];
    const td = o.m>0 ? o.d/o.m : 0;
    const te = o.m>0 ? o.wx/o.m : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${k}</td><td>${o.nb}</td><td>${money(o.m)}</td><td>${money(o.d)}</td><td>${pct(td)}</td><td>${(Math.round(te*10)/10)}%</td>`;
    tbody.appendChild(tr);
  });
}

function refreshAllSummaries(){
  const tb = document.getElementById('tbl');
  tb.innerHTML = '';

  let total=0, dec=0, wx=0;
  const rows = [];
  const statuses = new Set();

  allItems.eachLayer(l=>{
    if(!map.hasLayer(l)) return;

    const p=(l.feature && l.feature.properties) || {};
    statuses.add(p.statut||'');

    const m=toNum(p.montant);
    const d=toNum(p.montant_decaisse);
    const t=m>0 ? d/m : 0;
    const te=toNum(p.taux_execution);

    total += m; dec += d; wx += (isFinite(te)?te:0)*m;

    rows.push({statut:p.statut||'(vide)', region:p.region||'(vide)', montant:m, decaisse:d, tauxExec:(isFinite(te)?te:0)});

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><button class="btn" style="padding:4px 8px">√âditer</button></td>
      <td><button class="btn warn" style="padding:4px 8px">DEL</button></td>
      <td>${p.nom||''}</td><td>${p.region||''}</td><td>${p.statut||''}</td>
      <td>${p.montant||''}</td><td>${p.montant_decaisse||''}</td><td>${pct(t)}</td>
      <td>${p.taux_execution? p.taux_execution+'%' : ''}</td><td>${p.responsable||''}</td>
    `;

    // √âditer (maintenu)
    tr.querySelectorAll('button')[0].onclick = ()=> remplirDepuisLayer(l);

    // DEL (plus simple que la corbeille menu)
    tr.querySelectorAll('button')[1].onclick = ()=>{
      if(!confirm("Supprimer ce projet ?")) return;
      allItems.removeLayer(l);
      if(sel===l) sel=null;
      buildFilterOptions();
      applyFilters();
      safeAutoSaveLocal();
      autoPublishGitHub(); // ouvrir partout
    };

    tb.appendChild(tr);
  });

  const td = total>0 ? dec/total : 0;
  const te = total>0 ? wx/total : 0;
  document.getElementById('sum-total').textContent = money(total);
  document.getElementById('sum-decaisse').textContent = money(dec);
  document.getElementById('sum-taux-dec').textContent = pct(td);
  document.getElementById('sum-taux-exec').textContent = (Math.round(te*10)/10)+'%';

  fillGroupedTable(rows, 'statut', 'tblStatut');
  fillGroupedTable(rows, 'region', 'tblRegion');

  buildLegend(Array.from(statuses).filter(Boolean).sort((a,b)=>(''+a).localeCompare(b,'fr')));
}

function buildLegend(values){
  const cont=document.getElementById('legend');
  const items=document.getElementById('legendItems');
  items.innerHTML='';
  if(!values.length){ cont.style.display='none'; return; }
  values.forEach(v=>{
    const c=colorForStatut(v);
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`<span class="sw" style="background:${c}"></span><span>${v}</span>`;
    items.appendChild(div);
  });
  cont.style.display='block';
}

// ================== FILTER APPLY ==================
function applyFilters(){
  allItems.eachLayer(l=>{
    const p=(l.feature && l.feature.properties) || {};
    const ok = matchFilter(p);
    if(ok){ if(!map.hasLayer(l)) map.addLayer(l); }
    else  { if(map.hasLayer(l)) map.removeLayer(l); }
  });
  refreshAllSummaries();
}

// ================== RENDER ==================
function renderGeoJSON(j){
  allItems.clearLayers();

  const geo = L.geoJSON(j,{
    style:f=>({color:colorForStatut((f.properties||{}).statut||''),weight:2,fillOpacity:0.35}),
    pointToLayer:(f,latlng)=>{
      // par d√©faut: cercle (point), l'ic√¥ne (emoji) sera appliqu√©e dans setProps si p.icone existe
      return L.circleMarker(latlng,{radius:7,weight:1,color:"#000",fillColor:colorForStatut((f.properties||{}).statut||''),fillOpacity:0.9});
    },
    onEachFeature:(feat, lay)=>{
      lay.feature = feat;
      bindUI(lay, feat.properties||{});
      // appliquer style + ic√¥ne √©ventuelle
      const fixed = setProps(lay, feat.properties||{});
      // IMPORTANT: setProps peut remplacer le layer (circle->marker emoji)
      // donc on n'ajoute PAS lay, on ajoute fixed
      allItems.addLayer(fixed);
    }
  });

  try{
    const b=geo.getBounds();
    if(b && b.isValid()) map.fitBounds(b.pad(0.2));
  }catch(e){}

  buildFilterOptions();
  applyFilters();
}

function collectFC(){
  const feats=[];
  allItems.eachLayer(l=>feats.push(toFeature(l)));
  return {type:'FeatureCollection', features:feats};
}

// ================== LOCAL AUTOSAVE (s√©curit√©) ==================
function safeAutoSaveLocal(){
  try{ localStorage.setItem('projets_geojson_autosave', JSON.stringify(collectFC())); }catch(e){}
}

// ================== DRAW EVENTS ==================

// Cr√©ation : comme avant => formulaire pr√™t
map.on(L.Draw.Event.CREATED, e=>{
  let l = e.layer;
  allItems.addLayer(l);
  sel = l;

  // formulaire pr√™t
  document.getElementById('clear').click();
  nom.focus();

  // associe props vides (et convertit en point cercle)
  l = setProps(l, {});
  buildFilterOptions();
  applyFilters();

  safeAutoSaveLocal();
  autoPublishGitHub(); // ouvrir partout
});

map.on(L.Draw.Event.EDITED, ()=>{
  applyFilters();
  safeAutoSaveLocal();
  autoPublishGitHub();
});

map.on(L.Draw.Event.DELETED, ()=>{
  sel = null;
  buildFilterOptions();
  applyFilters();
  safeAutoSaveLocal();
  autoPublishGitHub();
});

// ================== BOUTONS FORM ==================
document.getElementById('clear').onclick=()=>{
  ['nom','montant','montant_decaisse','region','responsable','taux_execution'].forEach(id=>document.getElementById(id).value='');
  icone.value = '';
  statut.value='Planifi√©';
};

document.getElementById('apply').onclick=()=>{
  if(!sel){ alert("Cliquez d'abord sur un point/forme (projet) ou posez un point."); return; }

  const p = {
    nom: nom.value.trim(),
    montant: montant.value.trim(),
    montant_decaisse: montant_decaisse.value.trim(),
    region: region.value.trim(),
    statut: statut.value,
    responsable: responsable.value.trim(),
    taux_execution: (()=>{ const v=parseFloat(taux_execution.value.replace(',','.')); return isFinite(v)?String(v):''; })(),
    icone: icone.value
  };

  sel = setProps(sel, p);
  buildFilterOptions();
  applyFilters();

  safeAutoSaveLocal();
  autoPublishGitHub();
};

document.getElementById('del-selected').onclick=()=>{
  if(!sel){ alert("Cliquez d'abord sur un projet √† supprimer."); return; }
  if(!confirm("Supprimer ce projet ?")) return;

  allItems.removeLayer(sel);
  sel = null;

  buildFilterOptions();
  applyFilters();

  safeAutoSaveLocal();
  autoPublishGitHub();
};

// ================== IMPORT / EXPORT ==================
document.getElementById('export').onclick=()=>{
  const fc = collectFC();
  const blob = new Blob([JSON.stringify(fc,null,2)],{type:'application/geo+json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='projets.geojson';
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),300);
};

document.getElementById('import').onclick=()=>document.getElementById('file').click();
document.getElementById('file').onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const j=JSON.parse(await f.text());
    renderGeoJSON(j);
    safeAutoSaveLocal();
    autoPublishGitHub();
  }catch(err){ alert("Import KO: "+err.message); }
};

// ================== GITHUB SYNC ==================
const GH_USER="nmakhou-ux", GH_REPO="carte-projets", GH_BRANCH="main", GH_PATH="data/projets.geojson";
const RAW_URL=`https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/${GH_BRANCH}/${GH_PATH}`;
const API_URL=`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_PATH}`;

function b64(s){ return btoa(unescape(encodeURIComponent(s))); }
function getGhToken(){
  let t=localStorage.getItem('gh_token');
  if(!t){
    t=prompt("Collez votre GitHub Personal Access Token (scope: repo) :");
    if(!t) return null;
    localStorage.setItem('gh_token',t);
  }
  return t;
}

async function loadFromGitHub(){
  const r=await fetch(RAW_URL,{cache:'no-store'});
  if(!r.ok) throw new Error("Fichier GitHub introuvable");
  return await r.json();
}

async function saveToGitHub(fc){
  const token=getGhToken(); if(!token) return;
  let sha=null;

  const head=await fetch(API_URL,{headers:{Authorization:`Bearer ${token}`,Accept:'application/vnd.github+json'}});
  if(head.ok) sha=(await head.json()).sha;

  const res=await fetch(API_URL,{
    method:'PUT',
    headers:{Authorization:`Bearer ${token}`,Accept:'application/vnd.github+json','Content-Type':'application/json'},
    body:JSON.stringify({message:'update projets.geojson from app',content:b64(JSON.stringify(fc,null,2)),sha,branch:GH_BRANCH})
  });

  if(!res.ok){
    const t=await res.text();
    throw new Error(t||"Erreur API GitHub");
  }
}

document.getElementById('gh-token').onclick=()=>{
  const t=prompt("Collez votre token (scope: repo) :");
  if(t){ localStorage.setItem('gh_token',t); alert("Token enregistr√© ‚úî"); }
};
document.getElementById('gh-token-clear').onclick=()=>{ localStorage.removeItem('gh_token'); alert("Token effac√©."); };

document.getElementById('gh-load').onclick=async()=>{
  try{
    const j=await loadFromGitHub();
    // si GitHub vide => ne remplace pas l'√©cran
    if(!j || !j.features || j.features.length===0){
      alert("GitHub: 0 projet. Rien charg√©.");
      return;
    }
    renderGeoJSON(j);
    safeAutoSaveLocal();
    alert("Charg√© depuis GitHub ‚úÖ");
  }catch(e){ alert("Erreur chargement GitHub : "+e.message); }
};

document.getElementById('gh-save').onclick=async()=>{
  try{
    const fc=collectFC();
    if(!fc.features || fc.features.length===0){ alert("0 projet : publication annul√©e."); return; }
    await saveToGitHub(fc);
    alert("Publi√© sur GitHub ‚úÖ");
  }catch(e){ alert("Erreur publication GitHub : "+e.message); }
};

// ================== AUTO-PUBLISH (ouvrir partout) + anti-√©crasement vide ==================
let _ghSaveTimer = null;
function autoPublishGitHub(){
  clearTimeout(_ghSaveTimer);
  _ghSaveTimer = setTimeout(async ()=>{
    try{
      if (typeof saveToGitHub !== 'function') return;
      const fc = collectFC();
      const nb = (fc && fc.features) ? fc.features.length : 0;
      if (nb === 0) return; // anti-vide
      await saveToGitHub(fc);
    }catch(e){
      // silencieux (token manquant => normal)
      console.log("Auto GitHub publish FAILED", e);
    }
  }, 800);
}

// ================== START (affichage garanti) ==================
(function start(){
  // 1) autosave local si existe
  try{
    const t = localStorage.getItem('projets_geojson_autosave');
    if(t){
      const j = JSON.parse(t);
      if(j && j.features && j.features.length){
        renderGeoJSON(j);
        return;
      }
    }
  }catch(e){}

  // 2) sinon donn√©es int√©gr√©es (toujours visible)
  renderGeoJSON(INITIAL_DATA);
})();
</script>
</body>
</html>
