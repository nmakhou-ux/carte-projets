<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carte Projets ‚Äî filtres + synth√®ses + synchro GitHub</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<style>
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #layout{display:grid;grid-template-columns:480px 1fr;height:100vh}
  #side{padding:14px;overflow:auto;border-right:1px solid #ddd;background:#fafafa}
  #map{width:100%;height:100%}
  .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:12px;background:#fff}
  .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1 1 45%}
  .btn{padding:8px 10px;border:1px solid #bbb;border-radius:8px;background:#f5f5f5;cursor:pointer}
  .btn.warn{background:#ffe9e9;border-color:#f3b0b0}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left}
  .legend{position:absolute;bottom:20px;left:20px;z-index:1000;background:#fff;border:1px solid #333;border-radius:8px;padding:8px 10px}
  .legend .item{display:flex;align-items:center;gap:6px;margin-bottom:4px}
  .legend .sw{width:12px;height:12px;border:1px solid #333}
</style>
</head>
<body>
<div id="layout">
  <div id="side">
    <h3>Gestion & Suivi de Projets</h3>
<div style="padding:6px 10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:8px;background:#fff;font-size:12px"><b>VERSION_BUILD_ICONES</b> ‚Äî si vous voyez ce texte, c‚Äôest le bon fichier.</div>

    <!-- Filtres -->
    <div class="card">
      <b>Filtres</b>
      <div class="row" style="margin-top:6px">
        <div>
          <label>Statut</label>
          <select id="filtre-statut" style="width:100%"><option value="">Tous</option></select>
        </div>
        <div>
          <label>R√©gion</label>
          <select id="filtre-region" style="width:100%"><option value="">Toutes</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btn-reset">R√©initialiser</button>
      </div>
    </div>

    <!-- Saisie / Edition -->
    <div class="card">
      <b>Saisie / Edition</b>
      <div class="row" style="margin-top:6px"><div><label>Nom</label><input id="nom" style="width:100%"></div></div>
      <div class="row">
        <div><label>Montant</label><input id="montant" style="width:100%"></div>
        <div><label>D√©caiss√©</label><input id="montant_decaisse" style="width:100%"></div>
      </div>
      <div class="row">
        <div><label>R√©gion</label><input id="region" style="width:100%"></div>
        <div><label>Statut</label>
          <select id="statut" style="width:100%">
            <option>Planifi√©</option><option>En cours</option><option>En retard</option><option>Termin√©</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label>Responsable</label><input id="responsable" style="width:100%"></div>
        <div><label>Taux ex√©c. (%)</label><input id="taux_execution" style="width:100%"></div>
      </div>
      <div class="row">
        <div>
          <label>Ic√¥ne (optionnel)</label>
          <select id="icone" style="width:100%">
            <option value="">‚óè Point normal</option>
            <option value="üìç">üìç Projet</option>
            <option value="üè•">üè• Sant√©</option>
            <option value="üè´">üè´ √âducation</option>
            <option value="‚ö°">‚ö° √ânergie</option>
            <option value="üõ£Ô∏è">üõ£Ô∏è Route</option>
            <option value="üèóÔ∏è">üèóÔ∏è B√¢timent</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="apply">Associer au dessin s√©lectionn√©</button>
        <button class="btn" id="clear">Effacer</button>
      </div>
    </div>

    <!-- Synth√®se -->
    <div class="card">
      <b>Synth√®se (filtr√©e)</b>
      <div style="margin-top:6px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>Total: <b id="sum-total">0</b></div>
        <div>D√©caiss√©: <b id="sum-decaisse">0</b></div>
        <div>Taux d√©caissement: <b id="sum-taux-dec">0%</b></div>
        <div>Taux ex√©cution (pond√©r√©): <b id="sum-taux-exec">0%</b></div>
      </div>
    </div>

    <div class="card">
      <b>Liste (filtr√©e)</b>
      <table>
<thead><tr>
  <th></th>
  <th></th>
  <th>Projet</th><th>R√©gion</th><th>Statut</th><th>Montant</th><th>D√©caiss√©</th><th>% D√©c.</th><th>% Ex√©c.</th><th>Resp.</th>
</tr></thead>

        <tbody id="tbl"></tbody>
      </table>
    </div>

    <div class="card">
      <b>Synth√®se par Statut (filtr√©e)</b>
      <table id="tblStatut">
        <thead><tr><th>Statut</th><th>Nb</th><th>Montant</th><th>D√©caiss√©</th><th>% D√©c.</th><th>% Ex√©c. pond√©r√©</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <b>Synth√®se par R√©gion (filtr√©e)</b>
      <table id="tblRegion">
        <thead><tr><th>R√©gion</th><th>Nb</th><th>Montant</th><th>D√©caiss√©</th><th>% D√©c.</th><th>% Ex√©c. pond√©r√©</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Import / Export / Local / GitHub -->
    <div class="card">
      <div class="row">
        <button class="btn" id="export">Exporter GeoJSON</button>
        <button class="btn" id="import">Importer GeoJSON</button>
        <button class="btn" id="load-embedded">Recharger donn√©es int√©gr√©es</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btn-save-local">Sauvegarder (local)</button>
        <button class="btn" id="btn-load-local">Charger (local)</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="gh-load">Charger (GitHub)</button>
        <button class="btn" id="gh-save">Publier (GitHub)</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="gh-token">Enregistrer Token</button>
        <button class="btn warn" id="gh-token-clear">Effacer Token</button>
      </div>
      <div style="margin-top:6px;font-size:12px;opacity:.85">
        Fichier distant : <b>nmakhou-ux/carte-projets@main ‚Üí data/projets.geojson</b>
      </div>
      <input type="file" id="file" style="display:none" accept=".geojson,.json" />
    </div>
  </div>

  <div id="map">
    <div id="legend" class="legend" style="display:none">
      <div id="legendItems"></div>
    </div>
  </div>
</div>

<script>
// ===== Donn√©es int√©gr√©es =====
const INITIAL_DATA = {"type":"FeatureCollection","features":[
  {"type":"Feature","properties":{"nom":"Exemple ‚Äî Forage de Ndiass","montant":"125000000","montant_decaisse":"80000000","region":"Thi√®s","statut":"En cours","responsable":"A. Diop","taux_execution":"65"},"geometry":{"type":"Point","coordinates":[-17.07,14.67]}},
  {"type":"Feature","properties":{"nom":"Construction terminal port de dakar","montant":"45000000000","montant_decaisse":"","region":"Dakar","statut":"Planifi√©","responsable":"DIP","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-17.442169,14.681911]}},
  {"type":"Feature","properties":{"nom":"Construction Hh√¥pital de Saint louis","montant":"46000000000","montant_decaisse":"12000000000","region":"Saint louis","statut":"En retard","responsable":"DIS","taux_execution":"15"},"geometry":{"type":"Point","coordinates":[-16.413574,16.193575]}},
  {"type":"Feature","properties":{"nom":"Construction Hopital regional de K√©dougou","montant":"25000000000","montant_decaisse":"25000000000","region":"K√©dougou","statut":"Termin√©","responsable":"DIS","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-12.403564,12.715368]}},
  {"type":"Feature","properties":{"nom":"Construction pont de Ziguinchor","montant":"52000000000","montant_decaisse":"","region":"Ziguinchor","statut":"Planifi√©","responsable":"Ageroute","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-16.261139,12.537137]}},
  {"type":"Feature","properties":{"nom":"Construction lyc√©e de Matam","montant":"2500000000","montant_decaisse":"1200000000","region":"Matam","statut":"En cours","responsable":"DIE","taux_execution":"45"},"geometry":{"type":"Point","coordinates":[-13.820801,15.871525]}},
  {"type":"Feature","properties":{"nom":"Construction du port sec de Tambacounda","montant":"54000000000","montant_decaisse":"","region":"Tambacounda","statut":"Planifi√©","responsable":"AGEROUTE","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-13.612061,13.624633]}},
  {"type":"Feature","properties":{"nom":"Construction h√¥pital de Touba","montant":"46000000000","montant_decaisse":"25000000000","region":"Diourbel","statut":"En cours","responsable":"","taux_execution":"60"},"geometry":{"type":"Point","coordinates":[-15.954895,14.839939]}},
  {"type":"Feature","properties":{"nom":"Construction centre de sant√© de Lingu√®re","montant":"3000000000","montant_decaisse":"3000000000","region":"Louga","statut":"Termin√©","responsable":"","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-15.249023,15.315976]}}
]};

// ===== Carte =====
const map = L.map('map').setView([14.7,-17.4], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'}).addTo(map);
const allItems = new L.FeatureGroup().addTo(map);
map.addControl(new L.Control.Draw({draw:{polygon:true,polyline:true,rectangle:true,circle:false,marker:true,circlemarker:false},edit:{featureGroup:allItems}}));

let sel=null;
const STATUS_COLORS={"Planifi√©":"#1f77b4","En cours":"#2ca02c","En retard":"#d62728","Termin√©":"#9467bd"};
const FALLBACK=["#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];const extra={};
function colorForStatut(s){if(STATUS_COLORS[s])return STATUS_COLORS[s]; if(!extra[s]) extra[s]=FALLBACK[(Object.keys(extra).length)%FALLBACK.length]; return extra[s];}
function toFeature(layer){const gj=layer.toGeoJSON(); gj.properties=gj.properties||{}; return gj;}
function money(n){try{return new Intl.NumberFormat('fr-FR',{maximumFractionDigits:0}).format(n);}catch(e){return String(n);}}
function pct(x){return isFinite(x)?(Math.round(x*1000)/10)+'%':'0%';}
function toNum(v){if(v==null||v==='')return 0;const t=(''+v).replace(/\s/g,'').replace(',','.');const n=Number(t);return isFinite(n)?n:0;}
function popupHtml(p){const mt=toNum(p.montant),md=toNum(p.montant_decaisse),td=mt>0?md/mt:0;
  return `<b>${p.nom||'Projet'}</b><br><i>R√©gion:</i> ${p.region||''}<br><i>Statut:</i> ${p.statut||''}<br>
  <i>Montant:</i> ${p.montant||''}<br><i>D√©caiss√©:</i> ${p.montant_decaisse||''} (${pct(td)})<br>
  <i>Resp.:</i> ${p.responsable||''}<br><i>Taux ex√©c.:</i> ${p.taux_execution? p.taux_execution+'%' : ''}`;}
function bindUI(l,p){l.bindTooltip(p.nom||'Projet'); l.bindPopup(popupHtml(p),{maxWidth:420});}
function applyStyle(l,props){
  const color=colorForStatut(props.statut||'');
  if(l instanceof L.Marker && !l._isCircle){
    const cm=L.circleMarker(l.getLatLng(),{radius:7,weight:1,color:"#000",fillColor:color,fillOpacity:0.9});
    cm._isCircle=true; if(l._popup) cm.bindPopup(l._popup.getContent()); if(l._tooltip) cm.bindTooltip(l._tooltip._content);
    allItems.removeLayer(l); allItems.addLayer(cm); return cm;
  }
  if(l.setStyle) l.setStyle({color,weight:2,fillOpacity:0.35});
  return l;
}

function applyEmojiIcon(layer, props){
  const emoji = (props && props.icone) ? props.icone : '';
  if (!emoji) return layer;

  const latlng = layer.getLatLng ? layer.getLatLng() : null;
  if (!latlng) return layer;

  const icon = L.divIcon({
    className: '',
    html: `<div style="font-size:22px;line-height:22px">${emoji}</div>`,
    iconSize: [22, 22],
    iconAnchor: [11, 11]
  });

  // Si c'est d√©j√† un Marker, on met l'ic√¥ne
  if (layer instanceof L.Marker){
    layer.setIcon(icon);
    return layer;
  }

  // Sinon (circleMarker), on remplace par un Marker emoji
  const m = L.marker(latlng, { icon });
  m.feature = layer.feature;

  if (layer._popup) m.bindPopup(layer._popup.getContent());
  if (layer._tooltip) m.bindTooltip(layer._tooltip._content);

  allItems.removeLayer(layer);
  allItems.addLayer(m);
  return m;
}

function setProps(l,props){
  const f=toFeature(l);
  f.properties=Object.assign({},f.properties||{},props);
  l.feature=f;
  bindUI(l,f.properties);

  const styled = applyStyle(l,f.properties);
  const finalLayer = applyEmojiIcon(styled, f.properties);
  sel = finalLayer;
  return finalLayer;
}
function saveLocal(){
  try{ localStorage.setItem(STORAGE_KEYS[0], JSON.stringify(collectFC())); alert('Donn√©es sauvegard√©es en local ‚úî'); allowAutoSave=true; }
  catch(e){ alert('Sauvegarde locale: '+e.message); }
}
function loadLocalAny(){
  for(const k of STORAGE_KEYS){
    const t=localStorage.getItem(k); if(!t) continue;
    try{ const j=JSON.parse(t); if(k!==STORAGE_KEYS[0]) localStorage.setItem(STORAGE_KEYS[0], JSON.stringify(j)); return j; }
    catch(e){}
  }
  return null;
}
function autoSaveIfAllowed(){ if(allowAutoSave) saveLocal(); }

// ===== Filtres =====
const fStatut = document.getElementById('filtre-statut');
const fRegion = document.getElementById('filtre-region');
document.getElementById('btn-reset').onclick=()=>{ fStatut.value=""; fRegion.value=""; applyFilters(); };

function uniqueSorted(arr){return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>(''+a).localeCompare(b,'fr'));}
function buildFilterOptions(){
  const stats=[], regs=[];
  allItems.eachLayer(l=>{
    const p=(l.feature&&l.feature.properties)||{};
    stats.push(p.statut); regs.push(p.region);
  });
  const s=uniqueSorted(stats), r=uniqueSorted(regs);
  fStatut.innerHTML='<option value="">Tous</option>'+s.map(x=>`<option>${x}</option>`).join('');
  fRegion.innerHTML='<option value="">Toutes</option>'+r.map(x=>`<option>${x}</option>`).join('');
}
fStatut.onchange = fRegion.onchange = ()=>applyFilters();

function matchFilter(p){
  const s=fStatut.value, r=fRegion.value;
  if (s && (p.statut||'')!==s) return false;
  if (r && (p.region||'')!==r) return false;
  return true;
}

// ===== Tableaux & synth√®ses (sur VISIBLE = filtr√©) =====
function refreshAllSummaries(){
  const tb = document.getElementById('tbl');
  tb.innerHTML = '';

  let total = 0, dec = 0, wx = 0;
  const rows = []; // pour regroupements

  allItems.eachLayer(l=>{
    if(!map.hasLayer(l)) return; // seulement les projets visibles (filtr√©s)

    const p = (l.feature && l.feature.properties) || {};
    const m = toNum(p.montant);
    const d = toNum(p.montant_decaisse);
    const t = m>0 ? d/m : 0;
    const te = toNum(p.taux_execution);

    total += m;
    dec   += d;
    wx    += (isFinite(te)?te:0) * m;

    rows.push({ statut: p.statut||'(vide)', region: p.region||'(vide)', montant: m, decaisse: d, tauxExec: (isFinite(te)?te:0) });

    // ---- ligne tableau (√âditer + DEL) ----
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><button class="btn" style="padding:4px 8px">√âditer</button></td>
      <td><button class="btn warn" style="padding:4px 8px">DEL</button></td>
      <td>${p.nom||''}</td><td>${p.region||''}</td><td>${p.statut||''}</td>
      <td>${p.montant||''}</td><td>${p.montant_decaisse||''}</td><td>${pct(t)}</td>
      <td>${p.taux_execution? p.taux_execution+'%' : ''}</td><td>${p.responsable||''}</td>
    `;

    // √âditer
    tr.querySelectorAll('button')[0].onclick = () => {
      sel = l;
      nom.value = p.nom || '';
      montant.value = p.montant || '';
      montant_decaisse.value = p.montant_decaisse || '';
      region.value = p.region || '';
      statut.value = p.statut || 'Planifi√©';
      responsable.value = p.responsable || '';
      taux_execution.value = p.taux_execution || '';
      if(document.getElementById('icone')) document.getElementById('icone').value = p.icone || '';
    };

    // Supprimer
    tr.querySelectorAll('button')[1].onclick = () => {
      if(!confirm("Supprimer ce projet ?")) return;
      allItems.removeLayer(l);
      if (sel === l) sel = null;
      buildFilterOptions();
      applyFilters();
      alert("Projet supprim√© ‚úÖ");
    };

    tb.appendChild(tr);
  });

  // ---- Synth√®se globale ----
  const td = total>0 ? dec/total : 0;
  const te = total>0 ? wx/total : 0;

  document.getElementById('sum-total').textContent = money(total);
  document.getElementById('sum-decaisse').textContent = money(dec);
  document.getElementById('sum-taux-dec').textContent = pct(td);
  document.getElementById('sum-taux-exec').textContent = (Math.round(te*10)/10) + '%';

  // ---- Synth√®se par Statut / R√©gion (filtr√©e) ----
  fillGroupedTable(rows, 'statut', 'tblStatut');
  fillGroupedTable(rows, 'region', 'tblRegion');
}

function fillGroupedTable(rows, key, tableId){
  const by = {};
  rows.forEach(r=>{
    const k = r[key] || '(vide)';
    if(!by[k]) by[k] = { nb:0, m:0, d:0, wx:0 };
    by[k].nb += 1;
    by[k].m  += r.montant;
    by[k].d  += r.decaisse;
    by[k].wx += r.tauxExec * r.montant;
  });

  const tbody = document.querySelector('#'+tableId+' tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  Object.keys(by).sort((a,b)=>(''+a).localeCompare(b,'fr')).forEach(k=>{
    const o = by[k];
    const td = o.m>0 ? o.d/o.m : 0;
    const te = o.m>0 ? o.wx/o.m : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${k}</td><td>${o.nb}</td><td>${money(o.m)}</td><td>${money(o.d)}</td><td>${pct(td)}</td><td>${(Math.round(te*10)/10)}%</td>`;
    tbody.appendChild(tr);
  });
}

// ===== Application des filtres =====
function applyFilters(){
  allItems.eachLayer(l=>{
    const p=(l.feature&&l.feature.properties)||{};
    const ok=matchFilter(p);
    if(ok){ if(!map.hasLayer(l)) map.addLayer(l); }
    else  { if(map.hasLayer(l)) map.removeLayer(l); }
  });
  refreshAllSummaries();
}

// ===== Rendu GeoJSON =====
function renderGeoJSON(j){
  allItems.clearLayers();
  const g=L.geoJSON(j,{
    style:f=>({color:colorForStatut((f.properties||{}).statut||''),weight:2,fillOpacity:0.35}),
    pointToLayer:(f,latlng)=>{
      const c=colorForStatut((f.properties||{}).statut||'');
      const cm=L.circleMarker(latlng,{radius:7,weight:1,color:"#000",fillColor:c,fillOpacity:0.9});
      cm._isCircle=true; return cm;
    },
    onEachFeature:(feat, lay)=>{ allItems.addLayer(lay); lay.feature=feat; bindUI(lay, feat.properties||{}); }
  });
  try{ const b=g.getBounds(); if(b && b.isValid()) map.fitBounds(b.pad(0.2)); }catch(e){}
  buildFilterOptions();
  applyFilters();
}

// ===== Dessin / Edition (autosave seulement si autoris√©) =====
map.on(L.Draw.Event.CREATED,e=>{let l=e.layer; allItems.addLayer(l); sel=l; l=setProps(l,{}); buildFilterOptions(); applyFilters(); autoSaveIfAllowed();});
map.on(L.Draw.Event.EDITED, ()=>{applyFilters(); autoSaveIfAllowed();});
map.on(L.Draw.Event.DELETED, ()=>{sel=null; buildFilterOptions(); applyFilters(); autoSaveIfAllowed();});

// Formulaire
document.getElementById('apply').onclick=()=>{
  if(!sel){alert('S√©lectionnez un objet.'); return;}
  let l=sel;
  const p={nom:nom.value.trim(),montant:montant.value.trim(),montant_decaisse:montant_decaisse.value.trim(),region:region.value.trim(),statut:statut.value,responsable:responsable.value.trim(),taux_execution:(()=>{const v=parseFloat(taux_execution.value.replace(',','.'));return isFinite(v)?String(v):'';})(),
    icone:(document.getElementById('icone')?document.getElementById('icone').value:'')
  };
  l=setProps(l,p); sel=l; buildFilterOptions(); applyFilters(); autoSaveIfAllowed();
};
document.getElementById('clear').onclick=()=>{['nom','montant','montant_decaisse','region','responsable','taux_execution','icone'].forEach(id=>document.getElementById(id).value=''); statut.value='Planifi√©';};

// Import / Export / Local
document.getElementById('export').onclick=()=>{
  const fc=collectFC();
  const blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/geo+json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='projets.geojson'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),300);
};
document.getElementById('import').onclick=()=>file.click();
document.getElementById('file').onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{ const t=await f.text(); const j=JSON.parse(t); renderGeoJSON(j); autoSaveIfAllowed(); }catch(err){ alert('Import KO: '+err.message); }
};
document.getElementById('load-embedded').onclick=()=>renderGeoJSON(INITIAL_DATA);

document.getElementById('btn-save-local').onclick=()=>saveLocal();
document.getElementById('btn-load-local').onclick=()=>{
  const j=loadLocalAny(); if(!j){ alert('Aucune sauvegarde locale trouv√©e'); return; }
  renderGeoJSON(j); allowAutoSave=true;
};

// ===== GitHub Sync (manuel) =====
const GH_USER="nmakhou-ux", GH_REPO="carte-projets", GH_BRANCH="main", GH_PATH="data/projets.geojson";
const RAW_URL=`https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/${GH_BRANCH}/${GH_PATH}`;
const API_URL=`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_PATH}`;

function b64(s){ return btoa(unescape(encodeURIComponent(s))); }
function getGhToken(){
  let t=localStorage.getItem('gh_token');
  if(!t){ t=prompt("Collez votre GitHub Personal Access Token (scope: repo) :"); if(!t) return null; localStorage.setItem('gh_token',t); }
  return t;
}
async function loadFromGitHub(){
  const r=await fetch(RAW_URL,{cache:'no-store'});
  if(!r.ok) throw new Error("Fichier GitHub introuvable");
  return await r.json();
}
async function saveToGitHub(fc){
  const token=getGhToken(); if(!token) return;
  let sha=null;
  const head=await fetch(API_URL,{headers:{Authorization:`Bearer ${token}`,Accept:'application/vnd.github+json'}});
  if(head.ok) sha=(await head.json()).sha;
  const res=await fetch(API_URL,{
    method:'PUT',
    headers:{Authorization:`Bearer ${token}`,Accept:'application/vnd.github+json','Content-Type':'application/json'},
    body:JSON.stringify({message:'update projets.geojson from app',content:b64(JSON.stringify(fc,null,2)),sha,branch:GH_BRANCH})
  });
  if(!res.ok){ const t=await res.text(); throw new Error(t||'Erreur API GitHub'); }
}
document.getElementById('gh-token').onclick=()=>{ const t=prompt("Collez votre token (scope: repo) :"); if(t){ localStorage.setItem('gh_token',t); alert("Token enregistr√© ‚úî"); } };
document.getElementById('gh-token-clear').onclick=()=>{ localStorage.removeItem('gh_token'); alert("Token effac√©."); };
document.getElementById('gh-load').onclick=async()=>{
  try{ const j=await loadFromGitHub(); renderGeoJSON(j); alert("Charg√© depuis GitHub ‚úÖ"); }
  catch(e){ alert("Chargement GitHub: "+e.message); }
};
document.getElementById('gh-save').onclick=async()=>{
  try{ await saveToGitHub(collectFC()); alert("Publi√© sur GitHub ‚úÖ"); }
  catch(e){ alert("Publication GitHub: "+e.message); }
};

// ===== D√©marrage (s√ªr) : GitHub -> local -> int√©gr√© =====
(function start(){
  // D√©marrage garanti : charge d'abord les donn√©es int√©gr√©es
  try{ renderGeoJSON(INITIAL_DATA); }catch(e){}
  // Ensuite, si GitHub est configur√©, l'utilisateur peut cliquer "Charger (GitHub)"
})();





</script>
</body>
</html>
