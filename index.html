<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carte Projets — GitHub Sync (nmakhou-ux/carte-projets)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<style>
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #layout{display:grid;grid-template-columns:420px 1fr;height:100%}
  #side{padding:14px;overflow:auto;border-right:1px solid #ddd}
  #map{width:100%;height:100%}
  .card{border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:10px}
  .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1 1 45%}
  .btn{padding:8px 10px;border:1px solid #bbb;border-radius:8px;background:#f5f5f5;cursor:pointer}
  .btn.warn{background:#ffe9e9;border-color:#f3b0b0}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left}
  .legend{position:absolute;bottom:20px;left:20px;z-index:1000;background:#fff;border:1px solid #333;border-radius:8px;padding:8px 10px}
  .legend .item{display:flex;align-items:center;gap:6px;margin-bottom:4px}
  .legend .sw{width:12px;height:12px;border:1px solid #333}
  small.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<div id="layout">
  <div id="side">
    <h3>Gestion & Suivi de Projets — GitHub Sync</h3>

    <div class="card">
      <div class="row">
        <button class="btn" id="load-github">Charger (GitHub)</button>
        <button class="btn" id="save-github">Publier (GitHub)</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="set-token">Enregistrer le token</button>
        <button class="btn warn" id="clear-token">Effacer le token</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="load-embedded">Charger mes données intégrées</button>
        <button class="btn" id="publish-embedded">Publier données intégrées → GitHub</button>
      </div>
      <div style="margin-top:6px;font-size:12px;opacity:.9">
        <small class="mono">nmakhou-ux/carte-projets/main/data/projets.geojson</small><br>
        Le token (scope: <b>repo</b>) est stocké localement (localStorage).
      </div>
    </div>

    <div class="card">
      <div class="row"><div><label>Nom</label><input id="nom" style="width:100%"></div></div>
      <div class="row">
        <div><label>Montant</label><input id="montant" style="width:100%"></div>
        <div><label>Décaissé</label><input id="montant_decaisse" style="width:100%"></div>
      </div>
      <div class="row">
        <div><label>Région</label><input id="region" style="width:100%"></div>
        <div><label>Statut</label>
          <select id="statut" style="width:100%">
            <option>Planifié</option><option>En cours</option><option>En retard</option><option>Terminé</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label>Responsable</label><input id="responsable" style="width:100%"></div>
        <div><label>Taux exéc. (%)</label><input id="taux_execution" style="width:100%"></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="apply">Associer au dessin sélectionné</button>
        <button class="btn" id="clear">Effacer</button>
      </div>
    </div>

    <div class="card">
      <b>Synthèse</b>
      <div style="margin-top:6px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>Total: <b id="sum-total">0</b></div>
        <div>Décaissé: <b id="sum-decaisse">0</b></div>
        <div>Taux décaissement: <b id="sum-taux-dec">0%</b></div>
        <div>Taux exécution (pondéré): <b id="sum-taux-exec">0%</b></div>
      </div>
    </div>

    <div class="card">
      <b>Liste (affichée)</b>
      <table>
        <thead><tr><th>Projet</th><th>Région</th><th>Statut</th><th>Montant</th><th>Décaissé</th><th>% Déc.</th><th>% Exéc.</th><th>Resp.</th></tr></thead>
        <tbody id="tbl"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="row">
        <button class="btn" id="export">Exporter GeoJSON</button>
        <button class="btn" id="import">Importer GeoJSON</button>
      </div>
      <input type="file" id="file" style="display:none" accept=".geojson,.json" />
    </div>
  </div>

  <div id="map">
    <div id="legend" class="legend" style="display:none">
      <div id="legendItems"></div>
    </div>
  </div>
</div>

<script>
// ====== CONFIG ======
const GH_USER   = "nmakhou-ux";
const GH_REPO   = "carte-projets";
const GH_BRANCH = "main";
const GH_PATH   = "data/projets.geojson";

// Données intégrées (tes points actuels)
const INITIAL_DATA = {"type":"FeatureCollection","features":[
  {"type":"Feature","properties":{"nom":"Exemple — Forage de Ndiass","montant":"125000000","montant_decaisse":"80000000","region":"Thiès","statut":"En cours","responsable":"A. Diop","taux_execution":"65"},"geometry":{"type":"Point","coordinates":[-17.07,14.67]}},
  {"type":"Feature","properties":{"nom":"Construction terminal port de dakar","montant":"45000000000","montant_decaisse":"","region":"Dakar","statut":"Planifié","responsable":"DIP","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-17.442169,14.681911]}},
  {"type":"Feature","properties":{"nom":"Construction Hhôpital de Saint louis","montant":"46000000000","montant_decaisse":"12000000000","region":"Saint louis","statut":"En retard","responsable":"DIS","taux_execution":"15"},"geometry":{"type":"Point","coordinates":[-16.413574,16.193575]}},
  {"type":"Feature","properties":{"nom":"Construction Hopital regional de Kédougou","montant":"25000000000","montant_decaisse":"25000000000","region":"Kédougou","statut":"Terminé","responsable":"DIS","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-12.403564,12.715368]}},
  {"type":"Feature","properties":{"nom":"Construction pont de Ziguinchor","montant":"52000000000","montant_decaisse":"","region":"Ziguinchor","statut":"Planifié","responsable":"Ageroute","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-16.261139,12.537137]}},
  {"type":"Feature","properties":{"nom":"Construction lycée de Matam","montant":"2500000000","montant_decaisse":"1200000000","region":"Matam","statut":"En cours","responsable":"DIE","taux_execution":"45"},"geometry":{"type":"Point","coordinates":[-13.820801,15.871525]}},
  {"type":"Feature","properties":{"nom":"Construction du port sec de Tambacounda","montant":"54000000000","montant_decaisse":"","region":"Tambacounda","statut":"Planifié","responsable":"AGEROUTE","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-13.612061,13.624633]}},
  {"type":"Feature","properties":{"nom":"Construction hôpital de Touba","montant":"46000000000","montant_decaisse":"25000000000","region":"Diourbel","statut":"En cours","responsable":"","taux_execution":"60"},"geometry":{"type":"Point","coordinates":[-15.954895,14.839939]}},
  {"type":"Feature","properties":{"nom":"Construction centre de santé de Linguère","montant":"3000000000","montant_decaisse":"3000000000","region":"Louga","statut":"Terminé","responsable":"","taux_execution":"0"},"geometry":{"type":"Point","coordinates":[-15.249023,15.315976]}}
]};

const RAW_URL = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/${GH_BRANCH}/${GH_PATH}`;
const API_URL = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_PATH}`;

// ====== Carte ======
const map = L.map('map').setView([14.7,-17.4], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OSM'}).addTo(map);
const allItems = new L.FeatureGroup().addTo(map);
map.addControl(new L.Control.Draw({draw:{polygon:true,polyline:true,rectangle:true,circle:false,marker:true,circlemarker:false},edit:{featureGroup:allItems}}));

let sel=null;
const STATUS_COLORS={"Planifié":"#1f77b4","En cours":"#2ca02c","En retard":"#d62728","Terminé":"#9467bd"};
const FALLBACK=["#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];const extra={};
function colorForStatut(s){if(STATUS_COLORS[s])return STATUS_COLORS[s]; if(!extra[s]) extra[s]=FALLBACK[(Object.keys(extra).length)%FALLBACK.length]; return extra[s];}
function toFeature(layer){const gj=layer.toGeoJSON(); gj.properties=gj.properties||{}; return gj;}
function b64(s){return btoa(unescape(encodeURIComponent(s)));}
function money(n){try{return new Intl.NumberFormat('fr-FR',{maximumFractionDigits:0}).format(n);}catch(e){return String(n);}}
function pct(x){return isFinite(x)?(Math.round(x*1000)/10)+'%':'0%';}
function toNum(v){if(v==null||v==='')return 0;const t=(''+v).replace(/\s/g,'').replace(',','.');const n=Number(t);return isFinite(n)?n:0;}
function popupHtml(p){const mt=toNum(p.montant),md=toNum(p.montant_decaisse),td=mt>0?md/mt:0;
  return `<b>${p.nom||'Projet'}</b><br><i>Région:</i> ${p.region||''}<br><i>Statut:</i> ${p.statut||''}<br>
  <i>Montant:</i> ${p.montant||''}<br><i>Décaissé:</i> ${p.montant_decaisse||''} (${pct(td)})<br>
  <i>Resp.:</i> ${p.responsable||''}<br><i>Taux exéc.:</i> ${p.taux_execution? p.taux_execution+'%' : ''}`;}
function bindUI(l,p){l.bindTooltip(p.nom||'Projet'); l.bindPopup(popupHtml(p),{maxWidth:420});}
function applyStyle(l,props){
  const color=colorForStatut(props.statut||'');
  if(l instanceof L.Marker && !l._isCircle){
    const cm=L.circleMarker(l.getLatLng(),{radius:7,weight:1,color:"#000",fillColor:color,fillOpacity:0.9});
    cm._isCircle=true; if(l._popup) cm.bindPopup(l._popup.getContent()); if(l._tooltip) cm.bindTooltip(l._tooltip._content);
    allItems.removeLayer(l); allItems.addLayer(cm); return cm;
  }
  if(l.setStyle) l.setStyle({color,weight:2,fillOpacity:0.35});
  return l;
}
function setProps(l,props){const f=toFeature(l); f.properties=Object.assign({},f.properties||{},props); l.feature=f; bindUI(l,f.properties); return applyStyle(l,f.properties);}

function refreshTableAndLegend(){
  const tb=document.getElementById('tbl'); tb.innerHTML='';
  let total=0,dec=0,wx=0; const statuses=new Set();
  allItems.eachLayer(l=>{
    if(!map.hasLayer(l)) return;
    const p=(l.feature&&l.feature.properties)||{};
    const m=toNum(p.montant), d=toNum(p.montant_decaisse), t=m>0?d/m:0, te=toNum(p.taux_execution);
    total+=m; dec+=d; wx+=(isFinite(te)?te:0)*m; if(p.statut) statuses.add(p.statut);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.nom||''}</td><td>${p.region||''}</td><td>${p.statut||''}</td>
                  <td>${p.montant||''}</td><td>${p.montant_decaisse||''}</td><td>${pct(t)}</td>
                  <td>${p.taux_execution? p.taux_execution+'%' : ''}</td><td>${p.responsable||''}</td>`;
    tb.appendChild(tr);
  });
  const td=total>0?dec/total:0, te=total>0?wx/total:0;
  document.getElementById('sum-total').textContent=money(total);
  document.getElementById('sum-decaisse').textContent=money(dec);
  document.getElementById('sum-taux-dec').textContent=pct(td);
  document.getElementById('sum-taux-exec').textContent=(Math.round(te*10)/10)+'%';
  buildLegend(Array.from(statuses).filter(Boolean).sort());
}
function buildLegend(values){
  const cont=document.getElementById('legend'), items=document.getElementById('legendItems');
  items.innerHTML=''; if(!values.length){cont.style.display='none';return;}
  values.forEach(v=>{const c=colorForStatut(v); const div=document.createElement('div'); div.className='item'; div.innerHTML=`<span class="sw" style="background:${c}"></span><span>${v}</span>`; items.appendChild(div);});
  cont.style.display='block';
}

// Formulaire
document.getElementById('apply').onclick=()=>{
  if(!sel){alert('Sélectionnez un objet.'); return;}
  let l=sel;
  const p={nom:nom.value.trim(),montant:montant.value.trim(),montant_decaisse:montant_decaisse.value.trim(),region:region.value.trim(),statut:statut.value,responsable:responsable.value.trim(),taux_execution:(()=>{const v=parseFloat(taux_execution.value.replace(',','.'));return isFinite(v)?String(v):'';})()};
  l=setProps(l,p); sel=l; refreshTableAndLegend();
};
document.getElementById('clear').onclick=()=>{['nom','montant','montant_decaisse','region','responsable','taux_execution'].forEach(id=>document.getElementById(id).value=''); statut.value='Planifié';};

// Sélection
allItems.on('click',e=>{
  sel=e.layer; const p=(sel.feature&&sel.feature.properties)||{};
  nom.value=p.nom||''; montant.value=p.montant||''; montant_decaisse.value=p.montant_decaisse||'';
  region.value=p.region||''; statut.value=p.statut||'Planifié'; responsable.value=p.responsable||''; taux_execution.value=p.taux_execution||'';
});

// Import / Export
document.getElementById('export').onclick=()=>{
  const feats=[]; allItems.eachLayer(l=>feats.push(toFeature(l)));
  const blob=new Blob([JSON.stringify({type:'FeatureCollection',features:feats},null,2)],{type:'application/geo+json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='projets.geojson'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),300);
};
document.getElementById('import').onclick=()=>file.click();
document.getElementById('file').onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{ const t=await f.text(); const j=JSON.parse(t); renderGeoJSON(j); }catch(err){ alert('Import KO: '+err.message); }
};

// Rendu GeoJSON
function renderGeoJSON(j){
  allItems.clearLayers();
  const g = L.geoJSON(j,{
    style: f => ({ color: colorForStatut((f.properties||{}).statut||''), weight:2, fillOpacity:0.35 }),
    pointToLayer: (f, latlng) => {
      const c = colorForStatut((f.properties||{}).statut||'');
      const cm = L.circleMarker(latlng,{radius:7,weight:1,color:"#000",fillColor:c,fillOpacity:0.9});
      cm._isCircle = true; return cm;
    },
    onEachFeature: (feat, lay) => { allItems.addLayer(lay); lay.feature = feat; bindUI(lay, feat.properties || {}); }
  });
  try{ const b=g.getBounds(); if(b && b.isValid()) map.fitBounds(b.pad(0.2)); }catch(e){}
  refreshTableAndLegend();
}

// Dessin
map.on(L.Draw.Event.CREATED,e=>{let l=e.layer; allItems.addLayer(l); sel=l; l=setProps(l,{}); refreshTableAndLegend();});
map.on(L.Draw.Event.EDITED,()=>{refreshTableAndLegend();});
map.on(L.Draw.Event.DELETED,()=>{sel=null; refreshTableAndLegend();});

// ======= GitHub utils =======
function getToken(){ let t = localStorage.getItem('gh_token');
  if (!t) { t = prompt("Collez votre GitHub Personal Access Token (scope: repo) :"); if (!t) return null; localStorage.setItem('gh_token', t); }
  return t;
}
document.getElementById('set-token').onclick=()=>{
  const t = prompt("Collez votre GitHub Personal Access Token (scope: repo) :");
  if(t){ localStorage.setItem('gh_token', t); alert("Token enregistré ✔"); }
};
document.getElementById('clear-token').onclick=()=>{ localStorage.removeItem('gh_token'); alert("Token effacé."); };

// Charger depuis GitHub
async function loadFromGitHub(){
  const r = await fetch(RAW_URL, { cache:'no-store' });
  if(!r.ok){ throw new Error("Fichier distant introuvable"); }
  const j = await r.json();
  renderGeoJSON(j);
}

// Publier vers GitHub (PUT /contents)
async function saveToGitHub(fc){
  const token = getToken(); if(!token) return;
  let sha = null;
  const head = await fetch(API_URL, { headers:{ Authorization:`Bearer ${token}`, Accept:'application/vnd.github+json' }});
  if (head.ok) sha = (await head.json()).sha;
  const res = await fetch(API_URL, {
    method:'PUT',
    headers:{ Authorization:`Bearer ${token}`, Accept:'application/vnd.github+json', 'Content-Type':'application/json' },
    body: JSON.stringify({ message:'update projets.geojson from app',
                           content: btoa(unescape(encodeURIComponent(JSON.stringify(fc,null,2)))),
                           sha, branch: GH_BRANCH })
  });
  if(!res.ok){ const t=await res.text(); throw new Error(t || 'API GitHub error'); }
}

// Actions
document.getElementById('load-github').onclick=async ()=>{ try{ await loadFromGitHub(); alert("Chargé depuis GitHub ✅"); }catch(e){ alert("Chargement GitHub: "+e.message); } };
document.getElementById('save-github').onclick=async ()=>{ try{ const feats=[]; allItems.eachLayer(l=>feats.push(toFeature(l))); const fc={type:'FeatureCollection',features:feats}; await saveToGitHub(fc); alert("Publié sur GitHub ✅"); }catch(e){ alert("Publication GitHub: "+e.message); } };

document.getElementById('load-embedded').onclick=()=>{ renderGeoJSON(INITIAL_DATA); alert("Données intégrées chargées ✅"); };
document.getElementById('publish-embedded').onclick=async ()=>{ try{ await saveToGitHub(INITIAL_DATA); renderGeoJSON(INITIAL_DATA); alert("Données intégrées publiées sur GitHub ✅"); }catch(e){ alert("Publication: "+e.message); } };

// Démarrage : GitHub > données intégrées
(async ()=>{ try{ await loadFromGitHub(); }catch(e){ renderGeoJSON(INITIAL_DATA); } })();
</script>
</body>
</html>
